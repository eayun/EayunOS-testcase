# 虚拟机的动态迁移
* 摘要

  虚拟机的动态迁移，意味着：主机维护后，或者手动执行迁移，虚拟机的内存数据会转移到另一台主机上。

##定义集群策略

* 定义集群策略，以做好迁移虚拟机的准备。

1. 登录Engine管理端后，点击左侧树形面板中的【展开所有】按键，在默认数据中心下点击默认集群，点击【集群】。
1. 在右侧的集群列表中，选择该集群，点击菜单中的【编辑】按键或右键选择【编辑】。
1. 在弹出的【编辑集群】窗口中，在【集群策略】-> 【选择策略】中选择集群策略（本实验中选择【none】，其他策略说明请参照文档），选择【调度程序优化】以及【其他属性】。
1. 在【Resilience策略】中选择【移植虚拟机】，点击【确定】，保存策略。
1. 策略设置成功，能够迁移虚拟机。

## 虚拟机的动态迁移

* 手动迁移虚拟机
  * 迁移普通虚拟机
    * 前提条件：新建了一台允许迁移的虚拟机，集群中至少有一台可用主机。

    1. 登录到Engine管理端后，点击左侧树形面板中的【展开所有】按键，在默认数据中心下点击默认集群，点击【集群】下的【虚拟机】。
    1. 在右侧虚拟机列表中显示所有可用的虚拟机，选择一台允许迁移的虚拟机，点击菜单中的【移植】按键或右键选择【移植】。
    1. 弹出【移植虚拟机】的窗口，可以选择【自主选择主机】，让虚拟机自主选择一台可迁移的主机；也可以【选择目的主机】，将虚拟机迁移到指定的主机上，点击【确定】。
    1. 虚拟机开始迁移，虚拟机状态变化为Migrating -> Up，在虚拟机的【迁移】属性中能够显示虚拟机迁移的进度。

  * 迁移Engine虚拟机

* 将主机切换到维护模式
  * 普通虚拟机的自动迁移
    * 前提条件：新建了一台允许迁移的虚拟机，集群中至少有一台可用主机。

    1. 登录到Engine管理端后，点击左侧树形面板中的【展开所有】按键，在默认数据中心下点击默认集群，点击集群下的【主机】。
    1. 在右侧主机列表中，选择运行了需要自动迁移的主机，点击菜单中的【维护】按键或右键选择【维护】。
    1. 弹出【维护主机】的确认窗口，点击【确定】，主机开始维护，主机状态变化为Prepare For Maintenance -> Maintenance。
    1. 虚拟机自动迁移到另一台可用的主机上，其状态变化为Migrating -> Up，在虚拟机的【迁移】属性中能够显示虚拟机迁移的进度。

  > #### 注意
  > 不支持Engine虚拟机的自动迁移。
  >  * 主机切换到维护模式时，Engine虚拟机的自动迁移是不可用的。主机会一直处于Preparing For Maintenance的状态，而虚拟机也没有迁移。
  >  * Engine虚拟机默认为只允许手动迁移，因此，将运行Engine虚拟机的主机设置为维护模式，Engine虚拟机不会迁移，而主机的维护模式也不会设置成功。

* 将虚拟机迁移到另一个集群中
  * 普通虚拟机的迁移

  1. 登录到Engine管理端后，点击左侧树形面板中的【展开所有】按键，在默认数据中心下点击默认集群，点击【集群】下的【虚拟机】。
  1. 在右侧虚拟机列表中显示所有可用的虚拟机，选择一台允许迁移的虚拟机，点击菜单中的【移植】按键或右键选择【移植】。
  1. 弹出【移植虚拟机】的窗口，点击【高级参数】展开。
  1. 在集群中选择目的集群，即要将虚拟机迁移到哪个集群中，点击【确定】。
  1. 虚拟机开始迁移，虚拟机状态变化为Migrating -> Up，在虚拟机的【迁移】属性中能够显示虚拟机迁移的进度。
  1. 虚拟机成功迁移到另一个集群中，在另一个集群中正常运行。

