# 虚拟机的高可用
* 摘要
  高可用和动态迁移是有区别的，高可用保证了虚拟机的运行，如果主机出现故障，如：主机崩溃（相当于断电）、主机网络异常、VDSM崩溃等，高可用虚拟机可以在另一台可用主机上自动重新启动，而不会影响业务。但目前高可用的前提是主机配置了电源管理，没有正确配置电源管理的主机上是无法实现虚拟机的高可用的。相对于虚拟机的动态迁移，则不需要主机配置电源管理，也不需要配置虚拟机的高可用。只有主机进入维护模式或手动执行的时候，会将主机上的虚拟机迁移到另一台主机上。而如果主机出现故障，虚拟机是无法迁移到另一台主机上或在另一台主机上重启的，只能通过【右键 -> 确认主机重启】以通知Engine主机的状态，让Engine对这台主机上的虚拟机进行相应的处理。


## 配置虚拟机高可用

1. 默认创建虚拟机的情况下，高可用是不勾选的，也就是没有启用高可用功能。
1. 选择一台虚拟机（运行中或非运行中虚拟机均可，HostedEngine虚拟机除外），点击菜单中的【编辑】按键或右键选择【编辑】。
1. 在弹出的【编辑虚拟机】窗口中，选择左侧的【高可用性】选项卡，勾选【高度可用的】，配置运行/移植队列的优先级为【高】，点击【确定】以保存配置。
1. 看到该虚拟机的【常规】子选项卡中，【高度可用的】显示为“是”，说明该虚拟机的高可用已经配置好；【优先权】显示为“高”，说明该虚拟机的高可用优先级是高。

## 主机重启

1. 前提条件：集群中运行了高可用虚拟机的主机上配置了电源管理，且集群中至少有一台可用的主机。
1. 在左侧树形面板中选择【虚拟机】，看集群中有哪些高可用虚拟机。
1. 在左侧树形面板中选择【主机】，选择运行了高可用虚拟机的主机（这台主机不能是运行着HostedEngine虚拟机的主机），点击菜单中的【电源管理】，在其下拉列表中点击【重启】。
1. 弹出【重启主机】窗口，确认是否重启主机，点击【确定】，主机重启，主机状态变化为Reboot -> Non Responsive -> Up。
1. 在主机状态变化到Non Responsive，点击【虚拟机】选项卡，观察高可用虚拟机的变化。
1. 能够看到高可用虚拟机在另一台可用主机上自动重启，虚拟机的状态变化为Down -> Powering Up -> Up。

## 虚拟机中断
* 摘要
  模拟虚拟机崩溃的情况。

1. ssh到运行了高可用虚拟机的主机上，执行命令`vdsClient -s 0 list table`。
1. 列出运行在该主机上的虚拟机的id号、进程号、虚拟机名称及状态。
1. 运行命令kill -9 [进程编号]，杀死该虚拟机进程，模拟虚拟机崩溃的情况。
1. 看到Engine管理端上虚拟机的状态变为Powering Up，事件提示为：“VM [VM_NAME] was restarted on Host [HOST_NAME]”。
1. 该高可用虚拟机在原本的主机上重启。

