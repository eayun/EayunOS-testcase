<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
    "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
    <!ENTITY % BOOK_ENTITIES SYSTEM "Test_Case.ent">
    %BOOK_ENTITIES;
]>

<section>
    <title>安装测试</title>
    <informaltable  frame='all'>	
        <tgroup cols='8' align='left' colsep='1' rowsep='1'>
            <colspec colname='c1'/>
            <colspec colname='c2'/>
            <colspec colname='c3'/>
            <colspec colname='c4'/>
            <colspec colname='c5'/>
            <colspec colname='c6'/>
            <colspec colname='c7'/>
            <colspec colname='c8'/>
            <tbody>
                <row>
                    <entry>项目编号</entry>
                    <entry></entry>
                    <entry>项目名称</entry>
                    <entry></entry>
                    <entry>测试日期</entry>
                    <entry></entry>		
                    <entry>测试人员</entry>		
                    <entry></entry>
                </row>
                <row>
                    <entry>测试用例编号</entry>
                    <entry></entry>
                    <entry>测试用例名称</entry>
                    <entry>&OVIRT;安装测试</entry>
                    <entry>作者</entry>
                    <entry>阎颖</entry>
                </row>
                <row>
                    <entry>测试用例描述(方法和目的)</entry>
                    <entry namest="c2" nameend="c8">
                        <para></para>
                        <para></para>
                    </entry>
                </row>
                <row>
                    <entry>测试环境设置</entry>
                    <entry namest="c2" nameend="c8">
                        <para></para>
                    </entry>
                </row>
            </tbody>
        </tgroup>
    </informaltable>

    <bridgehead>测试步骤</bridgehead>

    <section>
        <title>
            安装EayunOS虚拟化基础系统
        </title>

        <informaltable  frame='topbot'>
            <tgroup cols='5' align='left' colsep='1' rowsep='1'>
                <colspec colname='c1' colwidth='5*'/>
                <colspec colname='c2' colwidth='20*'/>
                <colspec colname='c3' colwidth='10*'/>
                <colspec colname='c4' colwidth='5*'/>
                <colspec colname='c5' colwidth='20*'/>
                <thead>
                    <row>
                        <entry>用例编号</entry>
                        <entry>操作</entry>
                        <entry>预期结果</entry>
                        <entry>实际结果</entry>
                        <entry>备注</entry>
                    </row>
                </thead>
                <tbody>
                    <row>
                        <entry>1</entry>
                        <entry>
                            <para>
                                安装Manage：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        安装eayunOS-20140320163644-x86_64-DVD.iso
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        若dhcp没有获取ip地址成功，则配置静态ip
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        修改/etc/reslov.conf文件内容如下：
                                        ;generated by /sbin/dhclient-script
                                        nameserver 219.234.181.239 
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        修改本地Hosts 文件 vi /etc/hosts 添加
                                        engine的ip engine的hostname
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        engine-setup (VDSM 项选择yes,配置过程中
                                        配置项设置不同选项会有什么效果)
                                    </para>
                                </listitem>
                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                打开http://engine-ip可以看见搭建好的环境
                            </para>
                        </entry>
                        <entry>
                            <para>
                                安装测试基本通过，engine-setup运行时出现了几个问
                                题，见备注。
                            </para>
                        </entry>
                        <entry>
                            <orderedlist>
                                <listitem>
                                    <formalpara>
                                        <title>
                                            需要防火墙服务启动才可以继续
                                        </title>
                                        <para>
                                            All in One安装完成之后，iptables服务
                                            默认不会自动启动，engine-setup检测防
                                            火墙设置时不会通过。
                                        </para>
                                    </formalpara>
                                    <formalpara>
                                        <title>错误信息：</title>
                                        <para>
                                            The following firewall managers were detected on this system:                  
                                            iptables                                                                       
                                            Firewall manager to configure (iptables):                                      
                                            [ ERROR ] Invalid value                                                    
                                        </para>
                                    </formalpara>

                                    <formalpara>
                                        <title>临时解决办法：</title> 
                                        <para>
                                            service iptables start
                                        </para>
                                    </formalpara>
                                </listitem>
                                <listitem>
                                    <formalpara>
                                        <title>
                                            vdsmd服务默认不启动导致的一些问题
                                        </title>
                                        <para>
                                            默认vdsmd没有启动，需要手动启动
                                            vdsmd。但是问题是engine-setup是选择
                                            了启用vdsm，这些添加的localhost主机
                                            是不成功的。删除localhost之后，重新
                                            添加，需要提前修改
                                            /etc/centos-release。而且添加主机
                                            时，选择了自动配置防火墙时，会导致防
                                            火墙规则发生变化，比如80端口无法访问
                                            等。
                                        </para>
                                    </formalpara>
                                </listitem>
                            </orderedlist>
                        </entry>
                    </row>
                    <row>
                        <entry>2</entry>
                        <entry>
                            <para>
                                安装Host：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        安装eayunos-node-iso-3.3-1.iso
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        安装界面中选择“Install or Upgrade” 按“Enter”键
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        选择“Install Hypervisor 3.1.0-0.999.456.e16 ” 按“Enter”键
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        选择“U.S.English”  按“Enter”键
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        选择“Location Device Name  Size” 按“Continue”
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        在Storage Volumes 按“Next”
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        输入Password及Confirm Password 按“Install”
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        等待安装，安装完成后重启，进入Console界面
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        在Console界面下配置Network项，设置Hostname(ovirt-test1.eayun.com)设置DNS Server 1(8.8.8.8),配置网卡IPv4 选择Static （IP Address，Netmask,Gateway）按“save”
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        在Console界面下配置oVirt Engine项，设置Management Server(192.168.176.188),Management Server Port (这里设置了80，设置443有bug)
                                    </para>
                                </listitem>
                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                host安装好后可以自动在engine上显示出来，同时也可以在engine界面添加该host
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                        <entry>
                            <orderedlist>
                                <listitem>
                                    <formalpara>
                                        <title>
                                            host上使用bonding无法向管理端注册。
                                        </title>
                                        <para>
                                            只能配置单网卡。
                                        </para>
                                    </formalpara>
                                </listitem>
                            </orderedlist>
                        </entry>
                    </row>
                    <row>
                        <entry>3</entry>
                        <entry>
                            <para>
                                连接到虚拟化管理平台：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        打开浏览器，输入http://ip.com(http://192.168.176.91)
                                        在门户（Portal）标题下，点击【管理员门户】
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        如果是首次访问该网站，EayunOS管理系统将对浏览器进行安全认证，点击继续浏览此网站，显示门户登录界面。
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        输入用户名、密码及域（这里我们输入admin、abc123、internal），点击【登录】。
                                    </para>
                                </listitem>
                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                成功登录了EayunOS虚拟化管理系统
                            </para>
                        </entry>
                        <entry>
                            <para>
                                测试通过。
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry>4</entry>
                        <entry>
                            <para>
                                在EayunOS虚拟化管理平台批准安装的Host：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        在EayunOS虚拟化管理平台树形面板点击【展开所有】按键，在默认的集群下，点击主机项，主机列表下显示可用的EayunOS Hypervisor（host）
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        选择你安装的hypervisor,点击菜单内的【批准】（Approve）按键，显示【Edit and Approve Host】对话框，点击【确定】
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        提示配置电源管理，在这里可以设置也可以不设置，点击【继续】，完成后主机状态从Non Operational->Up
                                    </para>
                                </listitem>
                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                批准的主机状态从Non Operational->Up
                            </para>
                        </entry>
                        <entry>
                            <para>
                                测试通过。
                            </para>
                        </entry>
                        <entry>
                            <para>
                                添加主机，有2种方式：
                            <orderedlist>
                                <listitem>
                                    <formalpara>
                                        <title>
                                            host主动注册，管理端验证
                                        </title>
                                        <para>
                                            host上admin shell中“oVirt Engine”菜
                                            单下配置管理端ip地址和端口之后，选择
                                            "Save &amp; Register"，之后在管理端
                                            进行approval，具体参见左侧的测试流程
                                        </para>
                                    </formalpara>
                                </listitem>

                                <listitem>
                                    <formalpara>
                                        <title>
                                            管理端主动添加host
                                        </title>
                                        <para>
                                            node光盘安装完成之后，root没有密码，
                                            也无法登录。为了在管理端手动添加
                                            host。需要在host的admin shell中
                                            “oVirt Engine”菜单下配置密码，此密码
                                            其实是root用户的密码，保存配置之后还
                                            会自动配置sshd服务允许root登录。
                                        </para>
                                    </formalpara>
                                </listitem>
                            </orderedlist>
                        </para>
                        </entry>
                    </row>
                    <row>
                        <entry>5</entry>
                        <entry>
                            <para>
                                配置网络：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        添加一个新的逻辑网络
                                        <orderedlist numeration="loweralpha">
                                            <listitem><para>
                                                    在&OVIRT;&MANAGER;树形面板中
                                                    点击【展开所有】
                                                    （Expand All）按钮，在默认集
                                                    群下，点击“网络”项。
                                            </para></listitem>
                                            <listitem><para>
                                                    点击“新建”按钮，填写“名称”、
                                                    “描述”，取消“虚拟机网络”选择
                                                    项。“集群”选项卡中，将默认集
                                                    群附加到新建的逻辑网络。
                                            </para></listitem>
                                            <listitem><para>
                                                    点击“确定”按钮，完成逻辑网络
                                                    的添加。
                                            </para></listitem>
                                        </orderedlist>
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        将新建的逻辑网络附加到主机
                                    </para>
                                    <para>
                                        对集群中所有的可用的主机，进行如下操作：
                                        <orderedlist numeration="loweralpha">
                                            <listitem><para>
                                                    选中主机，在下方面板中选择
                                                    ”网络接口”选项卡，点击“设立
                                                    主机网络“按钮。
                                            </para></listitem>
                                            <listitem><para>
                                                    在”设立主机网络“对话框中，将
                                                    右侧”未分配的逻辑网络“中新建
                                                    立的逻辑网络，拖动到左侧和指
                                                    定网卡对应的”未分配网络“之中。
                                            </para></listitem>
                                            <listitem><para>
                                                    在新建立的逻辑网络上，点击铅
                                                    笔形状的编辑按钮，开始设置网
                                                    络参数。
                                            </para></listitem>
                                            <listitem><para>
                                                    网络参数设置完成之后，回到
                                                    “设立主机网络”对话框，勾选
                                                    “包括网络配置”选项，点击“确
                                                    定”按钮完成配置。
                                            </para></listitem>
                                            <listitem><para>
                                                    点击“确定”按钮，完成逻辑网络
                                                    的添加。
                                            </para></listitem>
                                        </orderedlist>
                                    </para>
                                </listitem>
                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                新的逻辑网络创建成功，附加在该网络的host和存储可
                                以使用这一网络互相通信。
                            </para>
                        </entry>
                        <entry>
                            <para>
                                创建逻辑网络成功，网络连通性暂时没有完整测试。2
                                台host都是2块网卡，其中一台的空闲网卡没有网线。
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry>6</entry>
                        <entry>
                            <para>
                                配置存储（创建NFS存储）：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        在EayunOS虚拟化管理平台树形面板点击【展开所有】按键，在默认的数据中心下点击【存储】，可用的存储域显示在列表下，点击【新建域】，显示新建域对话框，配置以下选项：名称、数据中心、存储类型：Data/NFS、使用的主机、输出路径（如：192.168.176.157:/home/export）点击【确定】，新建的存储域显示在存储列表内，状态由Locked->Active 
                                    </para>
                                </listitem>
                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                存储域创建成功
                            </para>
                        </entry>
                        <entry>
                            <para>
                                OK
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry>6</entry>
                        <entry>
                            <para>
                                配置存储（创建iscsi存储）：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        在EayunOS虚拟化管理平台树形面板点击【展开所有】按键，在默认的数据中心下点击【存储】，可用的存储域显示在列表下，点击【新建域】，显示新建域对话框，配置以下选项：名称、数据中心、存储类型：Data/iSCSI、使用的主机、连接目标iSCSI存储，输入地址、端口号、用户认证，点击发现（Discover），iSCSI存储显示在列表里，选择存储后点击进入，点击【确定】，新建的存储域显示在存储列表内，状态由Locked->Active
                                    </para>
                                </listitem>
                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                存储域创建成功
                            </para>
                        </entry>
                        <entry>
                            <para>
                                测试通过。
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry>8</entry>
                        <entry>
                            <para>
                                配置存储（创建ISO存储）：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        在EayunOS管理平台树形面板先点击【展开所有】按键，点击本地存储数据中心，显示数据中心列表，选择数据中心
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        在该数据中心详细面板下，选择存储列表，点击【新建ISO】按键,在Attach ISO Library对话框下选择本地ISO域，点击OK
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        ISO域显示在存储列表内，同时状态为活跃（Active）
                                    </para>
                                </listitem>
                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                ISO域创建成功
                            </para>
                        </entry>
                        <entry>
                            <para>
                                OK
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry>9</entry>
                        <entry>
                            <para>
                                向ISO域上传镜像文件：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        使用engine-iso-loader工具上传ISO（如：engine-iso-loader --iso-domain=ISO_DOMAIN upload /tmp/CentOS-6.5-x86_64-LiveDVD.iso）
                                    </para>
                                </listitem>
                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                上传镜像成功
                            </para>
                        </entry>
                        <entry>
                            <para>
                                测试通过。
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>

                </tbody>
            </tgroup>
        </informaltable>
    </section>
    <section>
        <title>
            安装EayunOS虚拟化最小系统
        </title>

        <informaltable  frame='topbot'>
            <tgroup cols='5' align='left' colsep='1' rowsep='1'>
                <colspec colname='c1' colwidth='5*'/>
                <colspec colname='c2' colwidth='20*'/>
                <colspec colname='c3' colwidth='10*'/>
                <colspec colname='c4' colwidth='5*'/>
                <colspec colname='c5' colwidth='20*'/>
                <thead>
                    <row>
                        <entry>用例编号</entry>
                        <entry>操作</entry>
                        <entry>预期结果</entry>
                        <entry>实际结果</entry>
                        <entry>备注</entry>
                    </row>
                </thead>
                <tbody>
                    <row>
                        <entry>10</entry>
                        <entry>
                            <para>
                                安装Manage：（同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                （同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                同安装基础系统
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry>11</entry>
                        <entry>
                            <para>
                                安装Host：（同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                （同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                同安装基础系统
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry>12</entry>
                        <entry>
                            <para>
                                连接到虚拟化管理平台:（同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                （同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                OK
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry>13</entry>
                        <entry>
                            <para>
                                创建本地存储：
                            </para>
                            <orderedlist numeration="arabic">
                                <listitem>
                                    <para>
                                        在EayunOS虚拟化管理平台树形面板，点击【展开所有】，在默认的集群下，点击【主机】，在主机的列表下显示可用的主机。
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        选中主机，点击【维护】，主机状态由“Preparing for Maintenance”->“Maintenance”。
                                    </para>
                                </listitem>
                                <listitem>
                                    <para>
                                        点击【配置本地存储】，显示“配置本地存储”窗口，在“常规”列表下，指定本地存储域的路径，保留其它默认设置，点击【确定】。
                                    </para>
                                </listitem>

                            </orderedlist>
                        </entry>
                        <entry>
                            <para>
                                本地存储域被创建，并且自动创建了本地数据中心和本地集群
                            </para>
                        </entry>
                        <entry>
                            <para>
                                测试通过。
                            </para>
                        </entry>
                        <entry>
                            <orderedlist>
                                <listitem>
                                    <formalpara>
                                        <title>
                                            本地存储路径权限错误
                                        </title>
                                        <para>
                                            ”配置本地存储“中指定本地存储路径时，
                                            由于node iso安装之后绝大部分空间单独
                                            划分了一个逻辑卷/dev/HostVG/Data，挂
                                            载在/data目录下。在该目录下新建一个
                                            目录作为本地存储的路径时，会出现权限
                                            问题
                                        </para>
                                    </formalpara>
                                    <formalpara>
                                        <title>错误信息：</title>
                                        <para><screen>
                                            Traceback (most recent call last):                                             
                                            File "/usr/share/vdsm/storage/hsm.py", line 2367, in connectStorageServer
                                                conObj.connect() 
                                            File "/usr/share/vdsm/storage/storageServer.py", line 482, in connect
                                                self.checkTarget()
                                            File "/usr/share/vdsm/storage/storageServer.py", line 468, in checkTarget
                                                fileSD.validateDirAccess(self._path)
                                            File "/usr/share/vdsm/storage/fileSD.py", line 59, in validateDirAccess
                                                raise se.StorageServerAccessPermissionError(dirPath)                       
                                            StorageServerAccessPermissionError: Permission settings on the specified path do not allow access to the storage. Verify permission settings on the specified storage path.: 'path = /data/Local'
                                        </screen></para>
                                    </formalpara>

                                    <formalpara>
                                        <title>说明：</title> 
                                        <para>
                                            权限要求如下（/usr/share/vdsm/storage/fileSD.py:53-56）：                      
                                            <screen>
                                                supervdsm.getProxy().validateAccess(                                           
                                                constants.QEMU_PROCESS_USER,                                           
                                                (constants.DISKIMAGE_GROUP,                                            
                                                constants.METADATA_GROUP), dirPath,                                   
                                                (os.R_OK | os.X_OK))                                                   
                                            </screen>

                                            对应用户（/usr/lib64/python2.6/site-packages/vdsm/constants.py:35-41）：       
                                            <screen>
                                                VDSM_USER = 'vdsm'                                                             
                                                VDSM_GROUP = 'kvm'                                                             
                                                DISKIMAGE_USER = 'vdsm'                                                        
                                                DISKIMAGE_GROUP = 'qemu'                                                       
                                                METADATA_USER = 'vdsm'                                                         
                                                METADATA_GROUP = 'kvm'                                                         
                                                QEMU_PROCESS_USER = 'qemu'                                                     
                                            </screen>

                                            红帽的evaluation guide中提示，本地存储输入：/data/images/rhev，这个路径的权 
                                            限是没有问题的
                                        </para>
                                    </formalpara>
                                </listitem>
                            </orderedlist>
                        </entry>
                    </row>
                    <row>
                        <entry>14</entry>
                        <entry>
                            <para>
                                创建ISO存储：（同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                （同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                OK
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                    <row>
                        <entry>15</entry>
                        <entry>
                            <para>
                                向ISO域上传镜像文件：（同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                （同安装基础系统）
                            </para>
                        </entry>
                        <entry>
                            <para>
                                OK
                            </para>
                        </entry>
                        <entry>
                            <para>

                            </para>
                        </entry>
                    </row>
                </tbody>
            </tgroup>
        </informaltable>

        <note>
            <para>
                其他注意事项：
            </para>
        </note>
    </section>
</section>
