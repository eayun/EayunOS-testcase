# 虚拟机的Affinity组

## 策略描述
* Positive Affinity (Run Together) - 一个能够设置一同运行affinity的策略，以决定确认哪些虚拟机需要运行在同一个管理主机上。
* Anti (Negative) Affinity (Run Independently) - 一个能够设置独立运行的affinity策略，以决定确认哪些虚拟机要分开运行在不同的管理主机上。
* Must Condition (enforce = hard) - 这是个硬性条件，意味着两台或更多的虚拟机要运行在同一台管理主机上或者是独立的主机上，无视外部条件。
* Should Condition (enforce = soft) - 这是个软式条件，意味着有优先权，两台或更多的虚拟机会运行在同一个管理主机或在单独的主机上，但它不是硬性要求的。

## 测试

|测试编号|测试目的|操作|预期结果|实际结果|备注|
|--------|--------|----|--------|--------|----|
|1|测试强制的Positive Affinity策略（虚拟机专属于某台主机时）|<ul><li>前提：</li></ul><ol><li>集群里有两台以上虚拟机（vm1，vm2）</li><li>其中一台（vm1）被测试的虚拟机设置为专属于主机Host1</li><li>另一台（vm2）被测试的虚拟机专属于主机Host2且虚拟机设置为可自动迁移或手动迁移</li></ol><ul><li>操作：</li></ul><ol><li>点击【集群】选项卡，在集群列表中选择需要设置的集群</li><li>点击【Affinity组】子选项卡，点击菜单中的【新建】按键</li><li>在弹出的【新建Affinity组】窗口中，输入Affinity的名称、描述</li><li>勾选Positive和Enable</li><li>选择要添加到Affinity组中的虚拟机</li><li>点击【确定】</li><li>点击【虚拟机】选项卡，选择虚拟机vm1，点击运行</li><li>选择虚拟机vm2，点击运行</li><li>观察虚拟机的运行情况并尝试迁移vm2</li></ol>|<ol><li>看到【集群】选项卡的【Affinity组】子选项卡中显示新建的Affinity组的信息</li><li>虚拟机vm1运行在主机Host1上</li><li>虚拟机vm2运行在主机Host1上</li><li>无法迁移虚拟机vm2，事件中提示：`Migration failed, No available host found`</li></ol>||Positive是强制的，无视vm2专属于主机Host2的情况，使其运行在主机Host1上|
|2|测试强制的Positive Affinity策略（虚拟机不能迁移时）|<ul><li>前提：</li></ul><ol><li>集群里有两台以上虚拟机（vm1，vm2）</li><li>其中一台（vm1）被测试的虚拟机设置为专属于主机Host1</li><li>另一台（vm2）被测试的虚拟机专属于主机Host2且设置为**不可迁移**</li></ol><ul><li>操作：</li></ul><ol><li>将上述测试1的Affinity组中的两台虚拟机关闭</li><li>选择虚拟机vm2，点击菜单中的【编辑】按键</li><li>将虚拟机vm2设置为不可迁移</li><li>运行虚拟机vm1</li><li>运行虚拟机vm2</li><li>观察虚拟机的运行情况</li></ol>|<ol><li>虚拟机vm1运行在主机Host1上</li><li>虚拟机vm2无法运行，弹出错误窗口</li></ol>||Positive时强制的，虚拟机vm2不满足运行的条件，因此无法运行|
|3|测试可选的Positive Affinity策略（虚拟机专属于某台主机时）|<ul><li>前提：</li></ul><ol><li>集群里有两台以上虚拟机（vm1，vm2）</li><li>其中一台（vm1）被测试的虚拟机设置为专属于主机Host1</li><li>另一台（vm2）被测试的虚拟机专属于主机Host2且虚拟机设置为可自动迁移或手动迁移</li></ol><ul><li>操作：</li></ul><ol><li>点击【集群】选项卡，在集群列表中选择需要设置的集群</li><li>点击【Affinity组】子选项卡，点击菜单中的【新建】按键</li><li>在弹出的【新建Affinity组】窗口中，输入Affinity的名称、描述</li><li>勾选Positive，Enable不勾选</li><li>选择要添加到Affinity组中的虚拟机</li><li>点击【确定】</li><li>点击【虚拟机】选项卡，选择虚拟机vm1，点击运行</li><li>选择虚拟机vm2，点击运行</li><li>观察虚拟机的运行情况</li></ol>|<ol><li>看到【集群】选项卡的【Affinity组】子选项卡中显示新建的Affinity组的信息</li><li><li>虚拟机vm1运行在主机Host1上</li><li>虚拟机vm2运行在Host2上</li><li>虚拟机vm2不能迁移到除了Host1之外的其他主机上</li></ol>|||
|4|测试可选的Positive Affinity策略（虚拟机不能迁移时）|<ul><li>前提：</li></ul><ol><li>集群里有两台以上虚拟机（vm1，vm2）</li><li>其中一台（vm1）被测试的虚拟机设置为专属于主机Host1</li><li>另一台（vm2）被测试的虚拟机专属于主机Host2且设置为**不可迁移**</li></ol><ul><li>操作：</li></ul><ol><li>将上述测试3的Affinity组中的两台虚拟机关闭</li><li>选择虚拟机vm2，点击菜单中的【编辑】按键</li><li>将虚拟机vm2设置为不可迁移</li><li>运行虚拟机vm1</li><li>运行虚拟机vm2</li><li>观察虚拟机的运行情况并尝试迁移</li></ol>|<ol><li>虚拟机vm1运行在主机Host1上</li><li>虚拟机vm2运行在主机Host2上</li><li>由于虚拟机设置为不可迁移，因此迁移时弹出提示：`VM 附属于主机`</li></ol>|||
|5|测试强制的Negative Affinity策略（虚拟机专属于某台主机时）|<ul><li>前提：</li></ul><ol><li>集群里有两台以上虚拟机（vm1，vm2）</li><li>两台虚拟机设置为专属于同一台主机Host1</li><li>两台虚拟机均设置为可自动迁移或手动迁移</li></ol><ul><li>操作：</li></ul><ol><li>点击【集群】选项卡，在集群列表中选择需要设置的集群</li><li>点击【Affinity组】子选项卡，点击菜单中的【新建】按键</li><li>在弹出的【新建Affinity组】窗口中，输入Affinity的名称、描述</li><li>不勾选Positive，勾选Enable</li><li>选择要添加到Affinity组中的虚拟机</li><li>点击【确定】</li><li>点击【虚拟机】选项卡，选择虚拟机vm1，点击运行</li><li>选择虚拟机vm2，点击运行</li><li>观察虚拟机的运行情况并尝试迁移vm2</li></ol>|<ol><li>看到【集群】选项卡的【Affinity组】子选项卡中显示新建的Affinity组的信息</li><li>虚拟机vm1在主机Host1上运行</li><li>虚拟机vm2在主机Host2上运行，没有运行在Host1上</li><li>虚拟机vm2不允许移植到主机Host1上</li></ol>|||
|6|测试强制的Negative Affinity策略（虚拟机不能迁移时）|<ul><li>前提：</li></ul><ol><li>集群里有两台以上虚拟机（vm1，vm2）</li><li>两台虚拟机设置为专属于同一台主机Host1</li><li>两台虚拟机均设置为**不可迁移**</li></ol><ul><li>操作：</li></ul><ol><li>将上述测试5的Affinity组中的两台虚拟机关闭</li><li>选择虚拟机vm2，点击菜单中的【编辑】按键</li><li>将虚拟机vm2设置为不可迁移</li><li>运行虚拟机vm1</li><li>运行虚拟机vm2</li><li>观察虚拟机的运行情况</li></ol>|<ol><li>虚拟机vm1运行在主机Host1上</li><li>虚拟机vm2无法运行，弹出错误窗口</li></ol>|||
|7|测试可选的Negative Affinity策略（虚拟机专属于某台主机时）|<ul><li>前提：</li></ul><ol><li>集群里有两台以上虚拟机（vm1，vm2）</li><li>两台虚拟机设置为专属于同一台主机Host1</li><li>两台虚拟机均设置为可自动迁移或手动迁移</li></ol><ul><li>操作：</li></ul><ol><li>点击【集群】选项卡，在集群列表中选择需要设置的集群</li><li>点击【Affinity组】子选项卡，点击菜单中的【新建】按键</li><li>在弹出的【新建Affinity组】窗口中，输入Affinity的名称、描述</li><li>Positive和Enable均不勾选</li><li>选择要添加到Affinity组中的虚拟机</li><li>点击【确定】</li><li>点击【虚拟机】选项卡，选择虚拟机vm1，点击运行</li><li>选择虚拟机vm2，点击运行</li><li>观察虚拟机的运行情况并尝试迁移vm2</li></ol>|<ol><li>看到【集群】选项卡的【Affinity组】子选项卡中显示新建的Affinity组的信息</li><li>虚拟机vm1在主机Host1上运行</li>虚拟机vm2在主机Host1上运行</li><li>虚拟机vm2可以迁移到任意主机上</li></ol>|||
|8|测试可选的Negative Affinity策略（虚拟机不能迁移时）|<ul><li>前提：</li></ul><ol><li>集群里有两台以上虚拟机（vm1，vm2）</li><li>两台虚拟机设置为专属于同一台主机Host1</li><li>两台虚拟机均设置为**不可迁移**</li></ol><ul><li>操作：</li></ul><ol><li>将上述测试7的Affinity组中的两台虚拟机关闭</li><li>选择虚拟机vm2，点击菜单中的【编辑】按键</li><li>将虚拟机vm2设置为不可迁移</li><li>运行虚拟机vm1</li><li>运行虚拟机vm2</li><li>观察虚拟机的运行情况并尝试迁移vm2</li></ol>|<ol><li>虚拟机vm1运行在主机Host1上</li><li>虚拟机vm2运行在主机Host1上</li><li>虚拟机vm2不能迁移，因为设置为不允许迁移</li></ol>|||
|9|测试是否可以在强制的Positive Affinity策略组中选择两台正运行在不同主机的虚拟机加入Affinity组中|<ul><li>前提：</li></ul><ol><li>集群中运行着两台虚拟机（vm1，vm2）</li><li>其中一台（vm1）被测试的虚拟机设置为专属于主机Host1且设置为**不可迁移**<li>另一台（vm2）被测试的虚拟机专属于主机Host2且设置为**不可迁移**</li></ol><ul><li>操作：</li></ul><ol><li>点击【集群】选项卡，在集群列表中选择需要设置的集群</li><li>点击【Affinity组】子选项卡，点击菜单中的【新建】按键</li><li>在弹出的【新建Affinity组】窗口中，输入Affinity的名称、描述</li><li>勾选Positive和Enable</li><li>选择虚拟机vm1和vm2</li><li>点击【确定】</li></ol>|<ol><li>Affinity组新建不成功</li><li>弹出错误提示或在事件中有相关提示</li></ol>|<ol><li>Affinity组新建成功</li><li>没有相关提示</li></ol>||
|10|测试是否可以在强制的Negative Affinity策略组选择两台正运行在相同主机上的虚拟机加入Affinity组中|<ul><li>前提：</li></ul><ol><li>集群中运行着两台虚拟机（vm1，vm2）</li><li>两台虚拟机均设置为专属于主机Host1且设置为**不可迁移**</li></ol><ul><li>操作：</li></ul><ol><li>点击【集群】选项卡，在集群列表中选择需要设置的集群</li><li>点击【Affinity组】子选项卡，点击菜单中的【新建】按键</li><li>在弹出的【新建Affinity组】窗口中，输入Affinity的名称、描述</li><li>勾选Positive和Enable</li><li>选择虚拟机vm1和vm2</li><li>点击【确定】</li></ol>|<ol><li>Affinity组新建不成功</li><li>弹出错误提示或在事件中有相关提示</li></ol>|<ol><li>Affinity组新建成功</li><li>没有相关提示</li></ol>||
